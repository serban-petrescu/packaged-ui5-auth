sap.ui.define(["jquery.sap.global","sap/ui/core/library","./Factory","./selector/IdSelector","./selector/PropertySelector","./selector/CustomDataSelector","./selector/ElementTypeSelector","./action/BaseAction","./action/RemoveAction","./action/SetPropertyAction","./action/BindPropertyAction","./helper/ExpressionHelper","sap/ui/model/json/JSONModel","sap/ui/core/mvc/XMLView","./ControlIterator","sap/ui/base/BindingParser","./action/AssociationDynamicAction","./action/ParentDynamicAction"],function(t,e,r,a,n,u,o,s,i,c,l,p,f,h,d,g,y,P){"use strict";sap.ui.getCore().initLibrary({name:"spet.auth",version:"0.9.0",dependencies:["sap.ui.core"],types:[],interfaces:["spet.auth.ISelector","spet.auth.IAction"],controls:[],elements:["spet.auth.ExpressionHelper"],noLibraryCSS:!0});var _=r.getInstance();_.registerSelectorProvider("id",function(t){return new a(t)}),_.registerSelectorProvider("property",function(t){return new n(t)}),_.registerSelectorProvider("custom-data",function(t){return new u(t)}),_.registerSelectorProvider("element-type",function(t){return new o(t)}),_.registerActionProvider("nop",function(){return new s}),_.registerActionProvider("hide",function(){return new c({name:"visible",value:!1})}),_.registerActionProvider("show",function(){return new c({name:"visible",value:!0})}),_.registerActionProvider("disable",function(){return new c({name:"enabled",value:!1})}),_.registerActionProvider("enable",function(){return new c({name:"enabled",value:!0})}),_.registerActionProvider("set-property",function(t){return new c(t)}),_.registerActionProvider("bind-property",function(t){return new l(t)}),_.registerActionProvider("remove",function(){return new i}),_.registerActionProvider("dynamic",function(t){return t&&t.context&&"external"===t.context?new y(t):new P(t)}),spet.auth.buildRoleMap=function(){function e(e,r){return e.hasOwnProperty(r)?!e[r]&&(e[r]=!0,!0):(t.sap.log.warning("The role "+r+" was not present in the specification."),e[r]=!0,!0)}function r(t,r){var a,n={};for(a=0;a<t.length;++a)n[t[a]]=!1;for(a=0;a<r.length;++a)e(n,r[a]);return n}function a(t,r){var a=!1;for(var n in r)if(r.hasOwnProperty(n)&&r[n].length&&t[n])for(var u=0;u<r[n].length;++u)a=e(t,r[n][u])||a;return a}function n(t,r){var a=!1;for(var n in r)r.hasOwnProperty(n)&&r[n].getResult()&&(a=e(t,n)||a);return a}function u(t,e){var r,a,n={};for(var u in t)t.hasOwnProperty(u)&&(a=t[u],"string"==typeof a&&0===a.indexOf("{=")&&(a=g.parseExpression(a,2).result),r=new p({result:a}),r.bindElement({path:"/"}),r.setModel(e),n[u]=r);return n}return function(t,e){var o,s=r(t.roles||[],e),i=new f(s),c=u(t.expressions||{},i),l=t.implications||{};do{o=n(s,c)||a(s,l),i.refresh()}while(o);return s}}();var v={},M=!1;return spet.auth.buildContext=function(){function t(t,e){var r;return!t||":always"===t.toLowerCase()||((r=t.match(/^present:(.+)$/i))&&r.length>=2?!!e[r[1]]:(r=t.match(/^missing:(.+)$/i),r&&r.length>=2?!e[r[1]]:void 0))}function e(t,e){var r=(e.view||e.views||":all").split(","),a={action:_.createAction(e.action&&e.action.type,e.action),selector:_.createSelector(e.selector&&e.selector.type,e.selector)};if(r.length&&a.action&&a.selector)for(var n=0;n<r.length;++n)t.hasOwnProperty(r[n])||(t[r[n]]=[]),t[r[n]].push(a)}return function(r,a){var n,u={};for(n=0;n<r.length;++n)t(r[n].when,a)&&e(u,r[n]);return u}}(),spet.auth.processControlTree=function(e,r,a){var n=r.getViewName(),u=v[e],o=new t.Deferred;return u?u.then(function(t){var e,s=(t[":all"]||[]).concat(u[n]||[]),i=new d(a),c=function(t){t.action.initialize(r)},l=function(t){t.action.finalize()},p=function(t){t.selector.check(r,e)&&t.action.process(r,e,i)};for(s.forEach(c);null!==(e=i.next());)s.forEach(p);s.forEach(l),o.resolve()}):(t.sap.log.error("The component "+e+" is not registered."),o.resolve()),o.promise()},spet.auth.registerComponent=function(){function e(e){return"string"==typeof e?t.get(e).then(function(t){return t}):t.when(e)}function r(t,e){return spet.auth.processControlTree(e.componentId,t,t)}return function(a,n,u){var o=new t.Deferred;v[a]=o.promise(),M||(M=!0,h.registerPreprocessor("CONTROLS",r,!1)),t.when(e(n),e(u)).then(function(t,e){var r=spet.auth.buildRoleMap(t,e),a=spet.auth.buildContext(t.actions||[],r);o.resolve(a)})}}(),spet.auth},!1);